name: Regression Testing

on: [push]

jobs:
  build:
    name: Build SU2
    strategy:
      fail-fast: false
      matrix: 
        config_set: [Base, Reverse, Forward]
        include:
          - config_set: Base
            flags: '-Denable-pywrapper=true'
          - config_set: Reverse
            flags: '-Denable-autodiff=true -Denable-normal=false'
          - config_set: Forward
            flags: '-Denable-directdiff=true -Denable-normal=false'          
    runs-on: ubuntu-latest
    steps:
      - name: Dump matrix context
        env:
            MATRIX_CONTEXT: ${{ toJson(matrix) }}
        run: echo "$MATRIX_CONTEXT"
      - name: Build Base
        uses: docker://su2code/build-su2
        with:
          args: ${{github.sha}} /github/workspace "${{matrix.flags}}"
      - name: Upload Binaries 
        uses: actions/upload-artifact@v1
        with:
          name: ${{ matrix.config_set }}
          path: bin
  tests:
    runs-on: ubuntu-latest
    name: Regression Tests
    needs: build
    strategy:
      fail-fast: false
      matrix: 
        config_set: [Base, AD]
        include:
          - config_set: Base
            testscript: 'parallel_regression.py'
          - config_set: AD
            testscript: 'parallel_regression_AD.py'
    steps:
      - name: Download Base
        uses: actions/download-artifact@v1
        with:
          name: Base
      - name: Download Reverse
        uses: actions/download-artifact@v1
        with:
          name: Reverse
      - name: Download Forward
        uses: actions/download-artifact@v1
        with:
          name: Forward  
      - name: Move Binaries
        run: |
          mkdir bin
          cp -r Base/. bin/
          cp -r Reverse/. bin/
          cp -r Forward/. bin/
          chmod a+x bin/*               
      - name: Run Tests in Container
        uses: docker://su2code/test-su2
        with:
          args: ${{github.sha}} develop develop /github/workspace ${{matrix.testscript}}
  
